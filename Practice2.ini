import xml.etree.ElementTree as ET
import os
import sys
from urllib.parse import urlparse
import urllib.request
import tarfile
import io

CONFIG_FILE = "config.xml"

def load_config(path="config.xml"):
    tree = ET.parse(path)
    root = tree.getroot()
    package_name = root.findtext("package_name")
    repo_url = root.findtext("repository_url")
    return package_name, repo_url

def fetch_apkindex(repo_url):
    index_url = repo_url.rstrip("/") + "/APKINDEX.tar.gz"
    print(f"[INFO] Загружаем индекс пакетов: {index_url}")
    with urllib.request.urlopen(index_url) as response:
        data = response.read()
    with tarfile.open(fileobj=io.BytesIO(data), mode="r:gz") as tar:
        for member in tar.getmembers():
            if member.name == "APKINDEX":
                f = tar.extractfile(member)
                return f.read().decode("utf-8")
    raise FileNotFoundError("Файл APKINDEX не найден в архиве.")

def get_dependencies(package_name, index_data):
    entries = index_data.strip().split("\n\n")
    for entry in entries:
        lines = entry.split("\n")
        pkg = {}
        for line in lines:
            if len(line) > 2 and line[1] == ":":
                key, val = line.split(":", 1)
                pkg[key] = val.strip()
        if pkg.get("P") == package_name:
            deps = pkg.get("D", "")
            if deps:
                deps_list = deps.split()
                print(f"\n[+] Прямые зависимости пакета '{package_name}':")
                for d in deps_list:
                    print("  -", d)
                return deps_list
            else:
                print(f"[+] Пакет '{package_name}' не имеет зависимостей.")
                return []
    print(f"[!] Пакет '{package_name}' не найден в репозитории.")
    return None

def main():
    package_name, repo_url = load_config()
    print(f"=== Сбор данных для пакета: {package_name} ===")
    index_data = fetch_apkindex(repo_url)
    get_dependencies(package_name, index_data)

if __name__ == "__main__":
    main()